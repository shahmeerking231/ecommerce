<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body,
      html {
        width: 100%;
        height: 100vh;
        overflow-x: hidden;
        scroll-behavior: smooth;
        background-color: rgb(255, 252, 247);
      }

      main {
        width: 100vw;
        min-height: calc(87vh - 2rem);
        display: flex;
        justify-content: space-between;
        gap: 2rem;
        padding: 5vh;
      }

      section {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 2vh;
      }

      aside {
        flex: 1;
        height: fit-content;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 3vh;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .toast {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 1000;
      }
      .toast .alert {
        min-width: 25vh;
        min-height: 7vh;
        padding: 1.1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
      }
      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }
    </style>
  </head>
  <body class="bg-base-200">
    <header class="p-6 text-2xl font-bold border-b-2 p-2 mb-8">
      üõí Your Cart
    </header>

    <main>
      <section id="cart-section"></section>

      <aside>
        <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
        <div id="order-summary" class="mb-4">
          <p>Total Items: <span id="total-items">0</span></p>
          <p>Total Price: $<span id="total-price">0.00</span></p>
        </div>
        <div class="flex justify-between gap-4">
          <button class="btn btn-outline btn-primary" onclick="placeOrder()">
            Place Order
          </button>
          <button onclick="clearCart()" class="btn btn-outline btn-warning">
            Clear Cart
          </button>
        </div>
      </aside>
    </main>

    <script>
      // Fetch cart from localStorage
      const cart = JSON.parse(localStorage.getItem("cart")) || [];

      const section = document.getElementById("cart-section");
      const totalItemsEl = document.getElementById("total-items");
      const totalPriceEl = document.getElementById("total-price");

      let totalItems = 0;
      let totalPrice = 0;

      const toast = (msg, type) => {
        const toastDiv = document.createElement("div");
        toastDiv.classList.add("toast");
        const toastInnerDiv = document.createElement("div");
        toastInnerDiv.className = `alert alert-${type}`;
        toastInnerDiv.innerHTML = `<div><span>${msg}</span></div>`;
        toastDiv.appendChild(toastInnerDiv);
        document.body.appendChild(toastDiv);
        setTimeout(() => {
          document.body.removeChild(toastDiv);
        }, 3000);
      };

      if (cart.length === 0) {
        section.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`;
      } else {
        cart.forEach((item) => {
          totalItems += item.quantity;
          totalPrice += item.product.price * item.quantity;

          section.innerHTML += `
        <div class="flex bg-base-100 shadow-sm rounded-xl overflow-hidden">
          <img
            class="w-[18vh] h-[18vh] object-cover rounded-l-xl"
            src="${
              item.product.imageURL ||
              "https://img.daisyui.com/images/stock/photo-1635805737707-575885ab0820.webp"
            }"
            alt="${item.product.name}"
          />
          <div class="card-body p-4 flex w-full justify-between">
            <div>
              <h2 class="card-title">${item.product.name}</h2>
              <p class="text-sm text-gray-600">${item.product.description}</p>
              <div class="card-actions justify-between items-center mt-2">
                <span class="text-lg font-semibold text-primary">$${
                  item.product.price
                }</span>
                <span class="text-lg font-semibold text-primary">Qty: ${
                  item.quantity
                }</span>
              </div>
            </div>
            <button class="btn btn-error btn-sm remove-item" data-id="${
              item.product._id
            }">‚ùå</button>
          </div>
        </div>`;
        });
      }

      // Update totals
      totalItemsEl.textContent = totalItems;
      totalPriceEl.textContent = totalPrice.toFixed(2);

      document.querySelectorAll(".remove-item").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const updatedCart = cart.filter((p) => p.product._id !== id);

          localStorage.setItem("cart", JSON.stringify(updatedCart));
          location.reload();
        });
      });

      function clearCart() {
        localStorage.removeItem("cart");
        location.reload();
      }
      function placeOrder() {
        if (cart.length === 0) {
          toast("Your cart is empty!", "warning");
          return;
        }
        fetch("/orders", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            products: cart,
            totalAmount: totalPrice,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              toast("Order placed successfully!", "success");
              clearCart();
            } else {
              toast("Failed to place order. Please try again.", "error");
            }
          })
          .catch((err) => {
            console.error("Error placing order:", err);
            toast("An error occurred. Please try again.", "error");
          });
      }
    </script>
  </body>
</html>
